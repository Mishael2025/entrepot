<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion d'Entrep√¥t</title>
    <link rel="stylesheet" href="../css/Entreosage.css?v=<?= time(); ?>">
    <link rel="stylesheet" href="../vendor/css/all.min.css">

    <script src="../node_modules/chart.js/dist/chart.min.js"></script>
  </head>

  <body>
    <div id="role-label" class="role-badge"></div>
    <div id="sidebar-container"></div>
    <input type="text" class="field-entreposage editable-field">

    <div id="dashboard" style="display: inline-block;">
      <header>
        <h1><i class="fas fa-chart-line"></i> Tableau de Bord</h1>

        <select id="sort-options">
          <option value="nom">Nom</option>
          <option value="quantite">Quantit√©</option>
          <option value="categorie">Cat√©gorie</option>
          <option value="date_peremption">Date de p√©remption</option>
        </select>

        <button id="download-report">
          <i class="fas fa-file-excel"></i> T√©l√©charger rapport
        </button>

      </header>
      <main>
        <section id="product-management">
          <div class="contenus">
            <form id="product-form" enctype="multipart/form-data">
              <h2>Gestion des Produits</h2>

              <div class="form-row">
                <input type="text" id="product-name"
                  placeholder="Nom du produit" required>
                <input type="number" id="quantity" placeholder="Quantit√©"
                  required>
              </div>

              <div class="form-row">
                <label for="unit">Unit√© :</label>
                <select id="unit" required>
                  <option value="kg">Kilogrammes (kg)</option>
                  <option value="L">Litres (L)</option>
                  <option value="pcs">Pi√®ces (pcs)</option>
                  <option value="box">Cartons (box)</option>
                </select>

                <label for="category">Cat√©gorie :</label>
                <select id="category" required>
                  <option value="frais">Frais</option>
                  <option value="surgel√©">Surgel√©</option>
                  <option value="sec">Sec</option>
                  <option value="liquide">Liquide</option>
                  <option value="Granules">Cereales</option>
                  <option value="Fruit">Fruits</option>
                  <option value="legumes">Legumes</option>
                  
                </select>
                <input type="number" name="prixunitaie" id="prix-unitaire"
                  placeholder="Prix unitaire" step="0.01"
                  required>
              </div>
              <div class="form-row">
                <label for="edit-photo"><i class="fas fa-camera"></i> Photo du
                  produit :</label>

                <input type="file" id="edit-photo" accept="image/*">
                <img id="preview-photo" src
                  style="display: none; width: 150px; border-radius: 8px; margin-top: 8px;">
              </div>

              <div class="form-row">
                <input type="date" id="expiry-date"
                  placeholder="Date de p√©remption" required>

                <label for="product-position"><i
                    class="fas fa-map-marker-alt"></i> Position :</label>

                <select id="product-position" required>
                  <option value="Cellule A1">Cellule A1</option>
                  <option value="Cellule A2">Cellule A2</option>
                  <option value="Rayon 1">Rayon 1</option>
                  <option value="Rayon 2">Rayon 2</option>
                  <option value="Rayon 3">Rayon 3</option>
                  <option value="R√©serve">R√©serve</option>
                </select>
              </div>

              <div class="form-row">
                <span class="badge badge-warning">Lot: YA-0725-8F</span>
                <span class="badge badge-dark">Code-barres: YA07258F</span>
                <select id="edit-status">
                  <option value="actif">Actif</option>
                  <option value="inactif">Inactif</option>
                </select>

              </div>
              <button type="submit" id="add-product-btn"><i
                  class="fas fa-plus-circle"></i>Ajouter</button>
            </form>

          </div>

          <div class="contenus">
            <div id="stocking-positions" class="stocking-panel">
              <h3>Emplacements disponibles</h3>
              <ul id="available-spots">
                <!-- Liste dynamique des cellules -->
              </ul>
            </div>
            <div class="organe">
              <button id="history-btn">Voir Historique</button>
            </div>
          </div>
          <div id="barcode-preview">
            <svg id="generated-barcode"></svg>
          </div>

          <input type="text" id="search-bar"
            placeholder="Rechercher un produit...">
          <div id="product-grid" class="product-grid">

            <div class="product-card">
              <!-- Produit 1 -->
            </div>

          </div>
        </section>

        <div id="edit-modal" class="modal">
          <div class="modal-content">
            <span class="close1">&times;</span>
            <h2>Modifier le produit</h2>

            <div class="form-row">
              <label>Nom du produit :</label>
              <input type="text" class="product-name" required>

              <label>Quantit√© :</label>
              <input type="number" class="quantity" required>
            </div>

            <div class="form-row">
              <label>Unit√© :</label>
              <select id="edit-unit" required>
                <option value="kg">kg</option>
                <option value="L">L</option>
                <option value="pcs">pcs</option>
                <option value="box">box</option>
              </select>

              <label>Cat√©gorie :</label>
              <input type="text" class="category" required>
            </div>

            <div class="form-row">
              <label for="expiry-date"><i class="fas fa-calendar-alt"></i> Date
                de p√©remption :</label>

              <input type="date" class="expiry-date" required>

              <label>Prix unitaire :</label>
              <input type="number" id="edit-price" placeholder="Prix unitaire"
                step="0.01" required>
            </div>

            <div class="form-row">
              <label>Position :</label>
              <select id="product-position" required>
                <option value="Cellule A1">Cellule A1</option>
                <option value="Cellule A2">Cellule A2</option>
                <option value="Rayon 3">Rayon 3</option>
                <option value="Rayon 2">Rayon 2</option>
                <option value="Rayon 1">Rayon 1</option>
                <option value="R√©serve">R√©serve</option>
              </select>
            </div>

            <div class="form-row">
              <span class="badge badge-warning"
                data-tooltip="Identifiant du lot">Lot: BA-0725-M3</span>

              <span class="badge badge-dark">
                Code-barres: <span class="code-barre">BA0725M3</span>
                <button class="copy-btn" onclick="copyCode()">üìã</button>
              </span>
            </div>

            <div class="form-row">
              <label>Statut :</label>
              <select id="edit-status">
                <option value="actif">Actif</option>
                <option value="inactif">Inactif</option>
              </select>

              <label>Photo du produit :</label>
              <input type="file" id="edit-photo" accept="image/*">
            </div>

            <img id="preview-photo" src
              style="display: none; width: 150px; border-radius: 8px; margin-top: 8px;">

            <button type="button" id="update-product-btn"><i
                class="fas fa-edit"></i>Mettre √† jour</button>
          </div>
        </div>
        <div id="history-modal" class="modal">
          <div class="modal-content">
            <span class="close-history">&times;</span>
            <h2><i class="fas fa-history"></i> Historique des op√©rations</h2>
            <table id="history-table">
              <thead>
                <tr>
                  <th>Date/Heure</th>
                  <th>Action</th>
                  <th>Produit</th>
                  <th>Utilisateur</th>
                  <th>D√©tails</th>
                </tr>
              </thead>
              <tbody>
                <!-- Les lignes seront ajout√©es dynamiquement -->
              </tbody>
            </table>
            <button id="clear-history"><i class="fas fa-trash-alt"></i> Vider
              l'historique</button>
          </div>
        </div>

      </main>
    </div>
    <script src="../js/sessionStorage.js"></script>
    <script src="../js/Historique.sortie.js"></script>
    <script src="../js/Emplacements.js"></script>
    <script src="../js/script.js"></script>
    <script>
  

   function appliquerRestrictionsPage() {
    const role = SessionManager.get("userRole") || "invit√©";
    const permissions = window.rolePermissions?.[role];

    if (!permissions) {
        console.warn(`‚ö†Ô∏è R√¥le inconnu : ${role}`);
        return;
    }


    // üîí Acc√®s interdit
    if (!permissions.canView) {
        document.body.innerHTML = "<h2 style='color:red;'>‚õî Acc√®s refus√©</h2>";
        return;
    }

    //  D√©sactivation des champs √©ditables
    if (!permissions.canEdit) {
        document.querySelectorAll("input, select, textarea").forEach(el => {
            el.disabled = true;
            el.classList.add("readonly");
        });
         document.querySelectorAll(".edit-btn").forEach(btn => {
            btn.disabled = true;
            btn.title = "‚õî √âdition non autoris√©e";
            btn.classList.add("btn-disabled");
        });
        document.getElementById("add-product-btn")?.remove();
        document.getElementById("update-product-btn")?.remove();
        document.getElementById("edit-photo")?.remove();
        document.getElementById("clear-history")?.remove();
        
    }

    //  Masquage des boutons sensibles
    if (!permissions.canDelete) {
        document.querySelectorAll(".btn-delete, .copy-btn").forEach(btn => btn.remove());
        document.getElementById("clear-history")?.remove();
        document.querySelectorAll(".delete-btn").forEach(btn => {
            btn.remove(); // ou btn.style.display = "none";
        });
    }

    //  Export et impression (optionnel)
    if (!permissions.canExport) {
        document.querySelector(".print-btn")?.remove();
        document.querySelector("a[href*='generate_stock_repport.php']")?.remove();
    }
}
document.addEventListener("DOMContentLoaded", appliquerRestrictionsPage);

    // Place ce code juste apr√®s l'injection du sidebar
    fetch("../html/sidebard.html")
      .then(r => r.text())
      .then(html => {
        const container = document.getElementById("sidebar-container");
        container.innerHTML = html;

        // ‚è± Attendre que le DOM inject√© soit bien interpr√©t√©
        setTimeout(() => {
          const logoutBtn = document.getElementById("logout-btn");
          if (logoutBtn) {
            logoutBtn.addEventListener("click", () => {
              sessionStorage.clear();
              localStorage.clear();
              window.location.href = "../html/PageConnexion.html";
            });
          } else {
            console.warn("üîç Bouton #logout-btn introuvable dans sidebard.html");
          }
        }, 50); // ‚Üê Ajustable selon la complexit√© du HTML inject√©
      });

    function copyCode() {
      const code = document.querySelector(".code-barre").textContent;
      navigator.clipboard.writeText(code);
      alert("Code-barres copi√©: " + code);
    }

  </script>
  </body>

</html>