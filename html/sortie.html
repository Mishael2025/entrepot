<!DOCTYPE html>
<html lang="fr">

  <head>
    <meta charset="UTF-8">
    <title>Sortie de Stock</title>
    <link rel="stylesheet" href="../css/sortie.css">
    <!--  Ajoute un fichier CSS si n√©cessaire -->
    <link rel="stylesheet" href="../vendor/css/all.min.css">
  </head>
  <script src="../libs/chart.umd.js"></script>
  <!-- üìå Version locale si install√©e -->

  <body>
    <textarea class="field-sortie editable-field"></textarea>
    <div id="role-label" class="role-badge"></div>

    <div id="sidebar-container"></div>
    <div class="main">
      <h1>Gestion des Sorties de Stock</h1>
      <div class="flex-zone">
        <form id="stock-out-form">
          <input type="text" id="product-name-out" placeholder="Nom du produit"
            required>
          <input type="number" id="quantity-out"
            placeholder="Quantit√© √† retirer" required>

          <label for="unit">Unit√© :</label>
          <select id="unit" required>
            <option value="kg">Kilos (kg)</option>
            <option value="L">Litres (L)</option>
            <option value="pcs">Pi√®ces (pcs)</option>
            <option value="box">Cartons (box)</option>
          </select>

          <label for="reason-out">Motif :</label>
          <select id="reason-out" required>
            <option value="vente">Vente</option>
            <option value="perte">Perte</option>
            <option value="donation">Donation</option>
            <option value="transfert">Transfert</option>
          </select>

          <input type="date" id="date-mouvement"> <!-- facultatif -->

          <input type="hidden" id="type-mouvement" value="sortie"> <!-- fixe -->

          <button id="remove-product-btn">Retirer Produit</button>
        </form>

        <div id="stock-sidebar">
          <input type="text" id="search-product"
            placeholder="Rechercher un produit..." />

          <div id="liste-produits" class="grille-produits">
            <h3>Produits en stock</h3>
            <div id="produits-stock-grid" class="grid-container"></div>
            <div id="no-results"
              style="display: none; margin-top: 10px; color: #888;">
              Aucun produit correspondant.
            </div>
          </div>
        </div>

      </div>

      <h2>√âvaluation des Sorties</h2>

      <div id="badges-container"></div>

      <canvas id="motif-chart"></canvas>
      <div class="selection">
        <select id="periode-selector" style="margin-bottom: 10px;">
          <option value="7">7 jours</option>
          <option value="30" selected>30 jours</option>
          <option value="90">90 jours</option>
        </select>

        <select id="produit-selector" aria-placeholder="select"></select>
      </div>
      <div id="chart-section">
        <h2>Statistiques</h2>

        <button id="refresh-btn">üîÑ</button>
      </div>
      <h2 id="jr"><i class="fas fa-file-lines text-primary"></i> Rapports
        journaliers</h2>
      <input type="date" id="date-select" />

      <select id="produit-select">
        <option value>-- S√©lectionner un produit --</option>
      </select>

      <div id="rapport-container">
        <i class="fas fa-truck-loading"></i> Livraison

      </div>
      <button id="print-btn">
        <i class="fas fa-print"></i> Imprimer le rapport
      </button>

      <script>
function appliquerRestrictionsPage() {
    const role = SessionManager.get("userRole") || "invit√©";
    const permissions = window.rolePermissions?.[role];

    if (!permissions) {
        console.warn(`‚õî R√¥le inconnu ou non d√©fini : ${role}`);
        return;
    }

    // üéñÔ∏è Badge visuel du r√¥le
    const roleLabel = document.getElementById("role-label");
    if (roleLabel) {
        roleLabel.innerHTML = getRoleBadge(role);
        roleLabel.title = `R√¥le : ${role}`;
        roleLabel.classList.add("role-badge", role);
    }

    // üîí Acc√®s interdit
    if (!permissions.canView) {
        document.body.innerHTML = "<h2 style='color:red;'>‚õî Acc√®s refus√©</h2>";
        return;
    }

    // üõ†Ô∏è D√©sactivation du formulaire de sortie
    if (!permissions.canEdit) {
        document.querySelectorAll("#stock-out-form input, #stock-out-form select, #stock-out-form textarea").forEach(el => {
            el.disabled = true;
            el.classList.add("readonly");
        });
        document.getElementById("remove-product-btn")?.remove();
    }

    // üóëÔ∏è Masquage des boutons de suppression dans les cartes produits
    document.querySelectorAll(".product-card").forEach(card => {
        const deleteBtn = card.querySelector(".delete-btn");
        const editBtn = card.querySelector(".edit-btn");

        if (editBtn && !permissions.canEdit) {
            editBtn.disabled = true;
            editBtn.title = "‚õî √âdition non autoris√©e";
            editBtn.classList.add("btn-disabled");
        }

        if (deleteBtn && !permissions.canDelete) {
            deleteBtn.remove();
        }
    });

    // üìä Restrictions sur les graphiques et rapports
    if (!permissions.canExport) {
        document.getElementById("print-btn")?.remove();
        //document.querySelector("canvas#motif-chart")?.style.display = "none";
        document.getElementById("refresh-btn")?.remove();
    }
}
document.addEventListener("DOMContentLoaded", appliquerRestrictionsPage);



      // Place ce code juste apr√®s l'injection du sidebar
      fetch("../html/sidebard.html")
        .then(r => r.text())
        .then(html => {
          const container = document.getElementById("sidebar-container");
          container.innerHTML = html;

          //  Attendre que le DOM inject√© soit bien interpr√©t√©
          setTimeout(() => {
            const logoutBtn = document.getElementById("logout-btn");
            if (logoutBtn) {
              logoutBtn.addEventListener("click", () => {
                sessionStorage.clear();
                localStorage.clear();
                window.location.href = "../html/PageConnexion.html";
              });
            } else {
              console.warn(" Bouton #logout-btn introuvable dans sidebard.html");
            }
          }, 50); // ‚Üê Ajustable selon la complexit√© du HTML inject√©
        });


    </script>
      <script src="../js/sessionStorage.js"></script>
      <script src="../js/Historique.sortie.js"></script>
      <script src="../js/sortie.js"></script>
      <!-- ‚úÖ Lien vers ton fichier JS -->
    </body>

  </html>